<!DOCTYPE html>
<html>
    <head>
        <title>Annotation tool - Developement | Adam - Mitsu</title>
        <!--script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script-->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <script src="js/konva.js" type="text/javascript"></script>

        <link rel ="stylesheet" type ="text/css" href = "style/style.css" />
        <link href="style/dashboard.css" rel="stylesheet"/>
        <link href="app/app.css" rel="stylesheet"/>
        <link href="app/vendor.css" rel="stylesheet"/>
        <link href="style/icon.css" rel="stylesheet"/>
        <link href="style/fontawesome.css" rel="stylesheet"/>
        <link href="style/solid.css" rel="stylesheet"/>
        

        <script src="js/jquery.min.js" type="text/javascript"></script>
        <script src="js/jquery-ui.min.js" type="text/javascript"></script>
        <link href="style/jquery-ui.css" rel="stylesheet"/>
    	  
        <link rel="stylesheet" type="text/css" href="style/evol-colorpicker.min.css"/>
        <link href="style/bootstrap.min.css" rel="stylesheet"/>
        <link href="style/dropdowntree.css" rel="stylesheet"/>
        
        <script src="js/evol-colorpicker.min.js" type="text/javascript"></script>
        <script src="js/app_v2.js" type="text/javascript"></script>
        <script src="js/control.js" type="text/javascript"></script>
        <script src="js/popper.min.js" type="text/javascript"></script>
        <script src="js/bootstrap.min.js" type="text/javascript"></script>
    </head>
    <body>

      <!-- main annotation  -->
      <div class="scene" style="width: calc(80%);">

          <!-- header -->
          <div class="headbar">
            <!-- header left group -->
             <div class="left-group">
                <div class="images-navigator" style="">
                   <div class="inline-block">
                    <a class="btn el-tooltip">
                      <i class="icon-chevron-left" style="position: absolute;margin-top: 2px;margin-left: -5px;"></i>
                    </a>
                   </div>
                   <div class="inline-block progress-wrapper">
                      <div class="progress-line"><b style="width: 0%;"></b></div>
                      <b class="image-name el-tooltip">
                      Brain PMD940_0180
                      </b> 
                      <div class="info">
                        <span class="titles el-tooltip">
                          <a href="https://app.supervise.ly/projects/36431" class="project-title">annotation
                          </a> 
                          <i class="icon-chevron-small-right chevron"></i>
                          <span class="dataset-title">001</span>
                        </span>
                      </div>
                   </div>
                   <div class="inline-block">
                    <a class="btn el-tooltip">
                      <i class="icon-chevron-right" style="position: absolute;margin-top: 2px;margin-left: -5px;"></i>
                    </a>
                  </div>
                   <!---->
                   <div class="el-loading-mask" style="display: none;">
                      <div class="el-loading-spinner">
                         <svg viewBox="25 25 50 50" class="circular">
                            <circle cx="50" cy="50" r="20" fill="none" class="path"></circle>
                         </svg>
                         <!---->
                      </div>
                   </div>
                </div>
             </div>
             <!-- header middle group -->
             <div class="navigator-wrapper">
                <div class="tool-options">
                   <div class="dropdown" style="margin-top: 10px">
                      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownClasses" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Annotation Classes
                      </button>
                      <ul id="annotated_class" class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
                          <li class="dropdown-submenu">
                            <a  class="dropdown-item" tabindex="-1" href="#">neurites</a>
                            <ul class="dropdown-menu">
                              <li class="dropdown-submenu">
                                <a class="dropdown-item" href="#">axons</a>
                                <ul class="dropdown-menu">
                                    <li class="dropdown-item"><a href="#">passing fiber</a></li>
                                    <li class="dropdown-item"><a href="#">axon fiber</a></li>
                                    <li class="dropdown-item"><a href="#">axon unidentifiable</a></li>
                                </ul>
                                <a class="dropdown-item" href="#">dendrites</a>
                                <a class="dropdown-item" href="#">neurties unidentifiable</a>
                              </li>
                            </ul>
                          </li>
                          <li class="dropdown-submenu">
                            <a class="dropdown-item" href="#">injection site</a>
                            <ul class="dropdown-menu">
                              <li class="dropdown-submenu">
                                <a class="dropdown-item" href="#">injection soma</a>
                                <a class="dropdown-item" href="#">injection area</a>
                              </li>
                            </ul>
                          </li>
                          <li class="dropdown-submenu">
                            <a class="dropdown-item" href="#">others</a>
                            <ul class="dropdown-menu">
                              <li class="dropdown-submenu">
                                <a class="dropdown-item" href="#">autofluorescence</a>
                                <a class="dropdown-item" href="#">artifact</a>
                              </li>
                            </ul>
                          </li>
                        </ul>
                   </div>
                   <div class="divider"></div>
                   <a id="undo_draw" class="btn">
                       <i class="zmdi zmdi-undo"></i><div>undo</div>
                   </a>
                   <a id="redo_draw" class="btn">
                       <i class="zmdi zmdi-wrap-text"></i><div>redo</div>
                   </a>
                   <a class="btn">
                       <i class="zmdi zmdi-spinner"></i><div>load</div>
                   </a>
                   <a class="btn">
                       <i class="zmdi zmdi-save"></i><div>save</div>
                   </a>
                   <a class="btn">
                       <i class="zmdi zmdi-download"></i><div>export</div>
                   </a>

                   <div class="divider"></div>

                   <div id="controlTool" class="toolBitmapOptions tool-options" style="margin-top: 8px;">
                      <button class="el-tooltip tool-button active" id="pointer_active">
                         <!----> <!----> <i class="icon-plus"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="pixel_active">
                         <!----> <!----> <i class="icon-round-brush"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="erase_active">
                         <!----> <!----> <i class="icon-eraser"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="fillcolor_active">
                         <!----> <!----> <i class="zmdi zmdi-format-color-fill"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="crop_active">
                         <!----> <!----> <i class="zmdi zmdi-crop"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="align_active">
                         <!----> <!----> <i class="icon-align-bottom"></i> <!---->
                      </button>
                      <div class="dropdown" style="margin-top: 2px;">         
                          <button id="selected-class" type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown"> 
                              pixel
                          </button> 
                            
                          <div id="brushsize_pixel" class="dropdown-menu"> 
                              <a class="dropdown-item" href="#" >1</a>
                              <a class="dropdown-item" href="#" >9</a>
                              <a class="dropdown-item" href="#" >25</a> 
                              <a class="dropdown-item" href="#" >49</a>
                          </div> 
                      </div>                      
                      <div class="magnify_style" style="width: 270px;margin-left: 30px; margin-top: 10px;">
                        <p style="position: absolute; font-size: 80%; font-weight: 400;">Magnify (x<label id="zoomlabel">1</label>)</p>
                        <input style="margin-top: -6px; margin-left: 15px;" type="range" min="0.1" max="40" step="0.1" class="slider2" id="myRange"/>
                      </div>
                   </div>
                   <div class="divider"></div>
                </div>
             </div>
        </div>
          <!-- end of header -->
          
          <div class="btn-toolbar mb-2 mb-md-0" style="padding-bottom:10px">
                  <div class="btn-group mr-2">
                      <div class="radio" style="padding-right:10px"><label><input type="radio" name="drawingtype" value="vector_linestring">Curve</label></div>
                      <div class="radio" style="padding-right:10px"><label><input type="radio" name="drawingtype" value="vector_polygon">Polygon</label></div>
                      <div class="radio" style="padding-right:10px"><label><input type="radio" name="drawingtype" value="raster_pixel" checked>Pixel</label></div> <!-- Mitsu -->
                      <div class="radio"><label><input type="radio" name="drawingtype" value="pointer" checked>Pointer</label></div> <!-- Mitsu -->
                  </div>
                  <div class="btn-group mr-2">
                          <button id="savebutton" class="btn btn-sm btn-outline-secondary">Save</button>
                          <button id="exportbutton" class="btn btn-sm btn-outline-secondary">Export
                          </button>
                  </div>
                  <div class="btn-group mr-2">
                  <span id="modelabel" class="label" style="padding-left:10px" >Brush size</span>
                    <select id="BrushSize">
                      <option value="1">1 pixel</option>
                      <option value="9" selected="selected">small</option>
                      <option value="25">medium</option>
                      <option value="49">large</option>
                    </select>
                  </div>
                  <label for="picker">Color</label>
                  <input id="picker" style="width:100px"/>
          </div>
        
          <div class="row">
            <div id="stage-parent" class="col-md-10" style="">
              <div id="container"></div>
            </div>
          </div>
        </div>

        <!-- end main annotation -->

        <!-- sidebar tile images -->
        <!-- panel-top -->
        <div class="sidebar" style="width: calc(20%);">
           <div class="split split">
              <div id="panel-top" class="panel" style="height: calc(50% - 2px);">
                 <div class="disabled-overlay" style="display: none;"></div>
                 <a class="panel-title">
                    <span class="title-text"><i class="panel-icon icon-images"></i>
                    Brain Tiles
                    </span> 
                    <i class="numbers">
                       <span>
                          total: 33
                       </span>
                    </i>
                    <div class="panel-tabs"></div>
                    <div class="actions">
                    </div>
                </a> 

                 <div class="panel-body">
                    <div class="el-scrollbar">
                       <div class="el-scrollbar__wrap" style="margin-bottom: -15px; margin-right: -15px; height: 600px;">
                          <div class="el-scrollbar__view" style="position: relative;">
                             <div class="images-list" style="">
                                <div class="table-list">
                                   <!----> <!----> 
                                   <table id='listTableTiles'>
                                      <tbody id='listOfTiles'> 
                                      </tbody>
                                   </table>
                                   <!---->
                                </div>
                                <div class="el-loading-mask" style="display: none;">
                                   <div class="el-loading-spinner">
                                      <svg viewBox="25 25 50 50" class="circular">
                                         <circle cx="50" cy="50" r="20" fill="none" class="path"></circle>
                                      </svg>
                                      <!---->
                                   </div>
                                </div>
                             </div>
                             <div class="resize-triggers">
                                <div class="expand-trigger">
                                   <div style="width: 317px; height: 299px;"></div>
                                </div>
                                <div class="contract-trigger"></div>
                             </div>
                          </div>
                       </div>
                       <div class="el-scrollbar__bar is-horizontal">
                          <div class="el-scrollbar__thumb" style="transform: translateX(0%);"></div>
                       </div>
                       <div class="el-scrollbar__bar is-vertical">
                          <div class="el-scrollbar__thumb" style="transform: translateY(0%); height: 62.0833%;"></div>
                       </div>
                    </div>
                 </div>
              </div>
              
              <!-- end panel-top -->
              <!-- panel-middle -->
              <div id="gutter-vertical-control-top" class="gutter gutter-vertical" style="height: 4px;"></div>
              <div id="panel-middle" class="panel" style="height: calc(20% - 2px);">
                <div class="disabled-overlay" style="display: none;"></div>
                <a class="panel-title">
                    <span class="title-text"><i class="panel-icon icon-layers"></i>
                    Annotation Tracking (Objects)
                    </span> 
                    <i class="numbers">
                       <span>
                          01
                       </span>
                    </i>
                    <div class="panel-tabs"></div>
                    <div class="actions">
                    </div>
                </a>
                <div class="panel-body">
                  <div class="el-scrollbar">
                     <div class="el-scrollbar__wrap" style="margin-bottom: -15px; margin-right: -15px; height: 600px;">
                        <div class="el-scrollbar__view" style="position: relative;">
                           <div class="figures-list">
                              <div class="table-list">
                                 <table id='list-body'>
                                    <tbody id='listOfAnnotation'> 
                                    </tbody>
                                 </table>
                                 <!---->
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div> 
              </div>
              <!-- end panel-middle -->
              <!-- panel-bottom -->
              <div id="gutter-vertical-control-bottom" class="gutter gutter-vertical" style="height: 4px;"></div>
              <div id="panel-bottom" class="panel" style="height: calc(30% - 2px);">
                <div class="disabled-overlay" style="display: none;"></div>
                <a class="panel-title">
                    <span class="title-text"><i class="panel-icon icon-section-1"></i>
                    Full Section
                    </span> 
                    <i class="numbers">
                       <span>
                          01
                       </span>
                    </i>
                    <div class="panel-tabs"></div>
                    <div class="actions">
                    </div>
                </a> 
                <img id='navImageSection' class="width: calc(20% - 3px); width: calc(20% - 3px);" src="">
              </div>
              <!-- end panel-bottom -->
        </div>
      </div>
      <!-- end sidebar control -->

      <script type="text/javascript">
        var section_image_size;
        var fullurl;
        $.getJSON('http://braincircuits.org/cgi-bin/iipsrv.fcgi?IIIF=/PITT001/Marmo_7NA_7_layers_1um_spacing.jp2/info.json', function(data) {
            width = `${data.width}`
            height = `${data.height}`
            let dect = [width, height];
            section_image_size = dect;
            generateTileTable(dect);
        });

        mouseclick();
        var nagImagesize = $(window).width() * 0.20 - 3;
        var imageaddress = "http://braincircuits.org/cgi-bin/iipsrv.fcgi?FIF=/PITT001/Marmo_7NA_7_layers_1um_spacing.jp2&WID="+nagImagesize + "&QLT=130&CNT=1&CVT=jpeg";
        $('#navImageSection').attr("src",imageaddress);
        selectedToolBtn();
        selectedpixel();
        selectedclasses();

        $(document).on("click", "#listTableTiles tbody tr", function() {
            imageid = $(this).closest('tr').attr('id');
            $('#' + imageid).click(function() {
               $(this).addClass('active');
               $(this).siblings().removeClass('active');
               res = imageid.split('-');
               selectedTile(res[1],section_image_size);
            });
        });
        var brain_id = getUrlVars()["brain_id"];
        generatesectiontils(brain_id);
      </script>
      
      <script type="text/javascript">
        $(document).ready(function() {
          setInitValue();
          initializeStage();
          setMouseEvt();
          setElementAct();

          // fitStageIntoParentContainer();
          // adapt the stage on any window resize
          // window.addEventListener('resize', fitStageIntoParentContainer);        
        });

      // // to be removed //
      // $(document).ready(function() {
      //   $('#picker').colorpicker({
      //       color:'#ff9800',
      //       // initialHistory: ['#ff0000','#000000','red', 'purple']
      //   });
      //   stage.add(layer);

      //   const nativeCtx = layer.getContext()._context;
      //   nativeCtx.webkitImageSmoothingEnabled = false;
      //   nativeCtx.mozImageSmoothingEnabled = false;
      //   nativeCtx.imageSmoothingEnabled = false;
      //   nativeCtx.msImageSmoothingEnabled = false;
      //   bgImage = new Image();

      //   xpix = 16000; // 16280.0 + 700;
      //   ypix = 7400 ; //11950.0 + 400;
      //   xpc = xpix / 24000.0;
      //   ypc = ypix / 18000.0;
      //   wpc = wid / 24000.0;
      //   hpc = hei / 18000.0;
      //   rgnstring = xpc + "," + ypc + "," + wpc + "," + hpc;
      //   //bgImage.src = "images/resolver_1020701_12800,16640,544,544.jpg";
      //   iipbase = "http://braincircuits.org/cgi-bin/iipsrv.fcgi?FIF=";
      //   // brainno = "PMD2055";
      //   seriesid = '3362';
      //   sectionid = '691261';
      //   apibase = "http://mitradevel.cshl.org/webtools/seriesbrowser";
      //   $.getJSON(apibase+'/getsectionjp2path/'+sectionid, function(data) {
      //       jp2filepath = data['jp2Path'];
            
      //       jp2pathdescribe(jp2filepath);
      //       bgImage.src =
      //           iipbase+jp2pathtranslate_(jp2filepath) +
      //           "&WID="+ wid +
      //           "&RGN=" + rgnstring +
      //           "&MINMAX=1:0,255&MINMAX=2:0,255&MINMAX=3:0,255&GAM=1&CVT=jpeg";
            
      //       $('#regdetails').html(''+xpix+','+ypix+'; '+wid+'x'+hei);
      //       bgImage.onload = function() {
      //           outimg = new Konva.Image({
      //               x: 0,
      //               y: 0,
      //               width: wid,
      //               height: hei,
      //               image: bgImage,
      //               draggable: false
      //           });
      //           layer.add(outimg);
      //           layer.draw();
      //           // layer_vector.draw();
      //           console.info('hello world');
      //       };
      //   });
      // });
      </script>
    </body>
</html>