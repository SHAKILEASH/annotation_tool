<!DOCTYPE html>
<html>
    <head>
        <title>Annotation tool - Developement | Adam - Mitsu</title>
        <!--script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script-->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <script src="js/konva.js" type="text/javascript"></script>

        <link rel = "stylesheet" type = "text/css" href = "style/style.css" />
        <link href="style/dashboard.css" rel="stylesheet"/>
        <link href="app/app.css" rel="stylesheet"/>
        <link href="app/vendor.css" rel="stylesheet"/>
        <link href="style/icon.css" rel="stylesheet"/>
        <link href="style/fontawesome.css" rel="stylesheet"/>
        <link href="style/solid.css" rel="stylesheet"/>

        <script src="js/jquery.min.js" type="text/javascript"></script>
        <script src="js/jquery-ui.min.js" type="text/javascript"></script>
        <link href="style/jquery-ui.css" rel="stylesheet"/>
    	  
        <link rel="stylesheet" type="text/css" href="style/evol-colorpicker.min.css"/>
        <link href="style/bootstrap.min.css" rel="stylesheet"/>

        <script src="js/bootstrap.min.js" type="text/javascript"></script>
        <script src="js/evol-colorpicker.min.js" type="text/javascript"></script>
        <script src="js/control.js" type="text/javascript"></script>
        <script type="text/javascript">
            var nagImagesize = $(window).width() * 0.20 - 3;
        </script>
    </head>
    <body>
      <!-- main annotation  -->
      <div class="scene" style="width: calc(80%);">

          <!-- header -->
          <div class="headbar">
            <!-- header left group -->
             <div class="left-group">
                <div class="images-navigator" style="">
                   <div class="inline-block">
                    <a class="btn el-tooltip">
                      <i class="icon-chevron-left" style="position: absolute;margin-top: 2px;margin-left: -5px;"></i>
                    </a>
                   </div>
                   <div class="inline-block progress-wrapper">
                      <div class="progress-line"><b style="width: 0%;"></b></div>
                      <b class="image-name el-tooltip">
                      Brain PMD940_0180
                      </b> 
                      <div class="info">
                        <span class="titles el-tooltip">
                          <a href="https://app.supervise.ly/projects/36431" class="project-title">annotation
                          </a> 
                          <i class="icon-chevron-small-right chevron"></i>
                          <span class="dataset-title">001</span>
                        </span>
                      </div>
                   </div>
                   <div class="inline-block">
                    <a class="btn el-tooltip">
                      <i class="icon-chevron-right" style="position: absolute;margin-top: 2px;margin-left: -5px;"></i>
                    </a>
                  </div>
                   <!---->
                   <div class="el-loading-mask" style="display: none;">
                      <div class="el-loading-spinner">
                         <svg viewBox="25 25 50 50" class="circular">
                            <circle cx="50" cy="50" r="20" fill="none" class="path"></circle>
                         </svg>
                         <!---->
                      </div>
                   </div>
                </div>
             </div>
             <!-- header middle group -->
             <div class="navigator-wrapper">
                <div class="tool-options">
                   <div class="toolCreateOptions tool-options">
                      <div class="toolCreateAndEditOptions">
                         <div>
                            <div class="el-select class-select-input">
                               <!---->
                               <div class="el-input el-input--small" style="margin-top: 8px;">
                                  <!----><i class="el-input__icon el-icon-caret-top"></i><input autocomplete="off" placeholder="Select" size="small" icon="caret-top" type="text" rows="2" class="el-input__inner"><!----><!---->
                               </div>
                               <div class="el-select-dropdown class-select-popper" style="display: none; min-width: 172px;">
                                  <div class="el-scrollbar" style="">
                                     <div class="el-select-dropdown__wrap el-scrollbar__wrap" style="margin-bottom: -15px; margin-right: -15px;">
                                        <ul class="el-scrollbar__view el-select-dropdown__list" style="position: relative;">
                                           <!---->
                                           <li class="el-select-dropdown__item" style="display: none;">
                                              <div class="item add-new-item"><span><i class="zmdi zmdi-plus"></i></span> <span class="middle">
                                                 Create class
                                                 </span>
                                              </div>
                                           </li>
                                           <li class="el-select-dropdown__item selected">
                                              <div class="item">
                                                 <span><b class="circle" style="background-color: rgb(175, 70, 107);"></b></span> <span class="middle">
                                                 testing
                                                 <small>Bitmap</small></span> 
                                                 <span>
                                                    <div class="hotkey">
                                                       H
                                                    </div>
                                                 </span>
                                              </div>
                                           </li>
                                           <div class="resize-triggers">
                                              <div class="expand-trigger">
                                                 <div style="width: 1px; height: 1px;"></div>
                                              </div>
                                              <div class="contract-trigger"></div>
                                           </div>
                                        </ul>
                                     </div>
                                     <div class="el-scrollbar__bar is-horizontal">
                                        <div class="el-scrollbar__thumb" style="transform: translateX(0%);"></div>
                                     </div>
                                     <div class="el-scrollbar__bar is-vertical">
                                        <div class="el-scrollbar__thumb" style="transform: translateY(0%);"></div>
                                     </div>
                                  </div>
                                  <!---->
                               </div>
                               <div class="resize-triggers">
                                  <div class="expand-trigger">
                                     <div style="width: 173px; height: 36px;"></div>
                                  </div>
                                  <div class="contract-trigger"></div>
                               </div>
                            </div>
                            <div class="el-dialog__wrapper add-class-dialog" style="display: none;">
                               <div class="el-dialog el-dialog--small" style="top: 15%;">
                                  <div class="el-dialog__header"><span class="el-dialog__title">Create class</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div>
                                  <!----><!---->
                               </div>
                            </div>
                         </div>
                      </div>
                   </div>

                   <div id="controlTool" class="toolBitmapOptions tool-options" style="margin-top: 8px;">
                      <button class="el-tooltip tool-button" id="pointer_active">
                         <!----> <!----> <i class="icon-plus"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="pixel_active">
                         <!----> <!----> <i class="icon-round-brush"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="erase_active">
                         <!----> <!----> <i class="icon-eraser"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="fillcolor_active">
                         <!----> <!----> <i class="zmdi zmdi-format-color-fill"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="crop_active">
                         <!----> <!----> <i class="zmdi zmdi-crop"></i> <!---->
                      </button>
                      <button class="el-tooltip tool-button" id="align_active">
                         <!----> <!----> <i class="icon-align-bottom"></i> <!---->
                      </button>
                      <span class="el-tooltip brush-size el-tooltip">
                         <div class="el-popover" style="width: 250px; display: none;">
                            <!----> 
                            <div data-v-88aaed5c="" class="el-slider">
                               <!---->
                               <div class="el-slider__runway">
                                  <div class="el-slider__bar" style="left: 0%; width: 1.56863%;"></div>
                                  <div class="el-slider__button-wrapper" style="left: 1.56863%;">
                                     <div class="el-slider__button el-tooltip"></div>
                                  </div>
                               </div>
                            </div>
                         </div>
                         <div style="display: flex; align-items: center;">
                            <input class="mr5"> <small style="margin-top: 10px;">px</small>
                         </div>
                      </span>
                      <div class="magnify_style" style="width: 270px;margin-left: 30px; margin-top: 10px;">
                        <p style="position: absolute; font-size: 80%; font-weight: 400;">Magnify (x<label id="zoomlabel">1</label>)</p>
                        <input style="margin-top: -6px; margin-left: 15px;" type="range" min="0.1" max="40" value="1" step="0.1" class="slider2" id="myRange"/>
                      </div>
                   </div>
                </div>
             </div>
          </div>
          <!-- end of header -->
          
          <div class="btn-toolbar mb-2 mb-md-0" style="padding-bottom:10px">
                  
                  <div class="btn-group mr-2">
                      <button id="undobutton" class="btn btn-sm btn-outline-secondary">Undo</button>
                      <button id="redobutton" class="btn btn-sm btn-outline-secondary">Redo</button>
                  </div>
                  <div class="btm=group mr-2">
                      <button id="loadbutton" class="btn btn-sm btn-outline-secondary">Load</button>
                  </div>
                  <!--button class="btn btn-sm btn-outline-secondary dropdown-toggle">
                      <span data-feather="calendar"></span>
                      This week
                  </button-->
                  <div class="btn-group mr-2">
                      <div class="radio" style="padding-right:10px"><label><input type="radio" name="drawingtype" value="vector_linestring">Curve</label></div>
                      <div class="radio" style="padding-right:10px"><label><input type="radio" name="drawingtype" value="vector_polygon">Polygon</label></div>
                      <div class="radio" style="padding-right:10px"><label><input type="radio" name="drawingtype" value="raster_pixel" checked>Pixel</label></div> <!-- Mitsu -->
                      <div class="radio"><label><input type="radio" name="drawingtype" value="pointer" checked>Pointer</label></div> <!-- Mitsu -->
                  </div>
                  <div class="col-md-2">
                      <span id="modelabel" class="label" style="padding-left:10px" >Erase</span>
                      <label class="switch">
                          <input type="checkbox" id="erase_check">
                          <span class="slider"></span>
                      </label>
                  </div>

                  <div class="btn-group mr-2">
                          <button id="savebutton" class="btn btn-sm btn-outline-secondary">Save</button>
                          <button id="exportbutton" class="btn btn-sm btn-outline-secondary">Export
                          </button>
                  </div>
                  <div class="btn-group mr-2">
                  <span id="modelabel" class="label" style="padding-left:10px" >Brush size</span>
                    <select id="BrushSize">
                      <option value="1">1 pixel</option>
                      <option value="9" selected="selected">small</option>
                      <option value="25">medium</option>
                      <option value="49">large</option>
                    </select>
                  </div>
          </div>
        
          <div class="row">
              <div id="stage-parent" class="col-md-10" style="">
                  <div  id="container"></div>
              </div>
<!--               <div class="col-md-2"> 
                      <form style="border:solid 1px;padding:5px">
                              <h5>Add object</h5>
                          
                          <div class="form-group">
                              <label for="objname">Label</label> 
                              <input type="text" id="objname" class="form-control"/>
                          </div>
                          
                          <div class="form-group">
                              <label for="picker">Color</label>
                              <input id="picker" style="width:100px"/>
                          </div>
                          <button id="start">Start</button><button id="end">End</button>
                      </form>
              </div> -->
          </div>
        </div>

        <!-- end main annotation -->

        <!-- sidebar tile images -->
        <div class="sidebar" style="width: calc(20%);">
           <div class="split split">
              <div id="panel-top" class="panel" style="height: calc(60% - 2px);">
                 <div class="disabled-overlay" style="display: none;"></div>
                 <a class="panel-title">
                    <span class="title-text"><i class="panel-icon icon-images-1"></i>
                    Brain Tiles
                    </span> 
                    <i class="numbers">
                       <span>
                          total: 33
                       </span>
                    </i>
                    <div class="panel-tabs"></div>
                    <div class="actions">
                    </div>
                </a> 

                 <div class="panel-body">
                    <div class="el-scrollbar">
                       <div class="el-scrollbar__wrap" style="margin-bottom: -15px; margin-right: -15px; height: 600px;">
                          <div class="el-scrollbar__view" style="position: relative;">
                             <div class="images-list" style="">
                                <div class="table-list">
                                   <!----> <!----> 
                                   <table id='listTableTiles'>
                                      <tbody id='listOfTiles'> 
                                      </tbody>
                                   </table>
                                   <!---->
                                </div>
                                <div class="el-loading-mask" style="display: none;">
                                   <div class="el-loading-spinner">
                                      <svg viewBox="25 25 50 50" class="circular">
                                         <circle cx="50" cy="50" r="20" fill="none" class="path"></circle>
                                      </svg>
                                      <!---->
                                   </div>
                                </div>
                             </div>
                             <div class="resize-triggers">
                                <div class="expand-trigger">
                                   <div style="width: 317px; height: 299px;"></div>
                                </div>
                                <div class="contract-trigger"></div>
                             </div>
                          </div>
                       </div>
                       <div class="el-scrollbar__bar is-horizontal">
                          <div class="el-scrollbar__thumb" style="transform: translateX(0%);"></div>
                       </div>
                       <div class="el-scrollbar__bar is-vertical">
                          <div class="el-scrollbar__thumb" style="transform: translateY(0%); height: 62.0833%;"></div>
                       </div>
                    </div>
                 </div>
              </div>
              <div id="gutter-vertical-control" class="gutter gutter-vertical" style="height: 4px;"></div>
              <div id="panel-bottom" class="panel" style="height: calc(40% - 2px);">
                <div class="disabled-overlay" style="display: none;"></div>
                <a class="panel-title">
                    <span class="title-text"><i class="panel-icon icon-section-1"></i>
                    Full Section
                    </span> 
                    <i class="numbers">
                       <span>
                          01
                       </span>
                    </i>
                    <div class="panel-tabs"></div>
                    <div class="actions">
                    </div>
                </a> 
                <img id='navImageSection' class="width: calc(20% - 3px); width: calc(20% - 3px);" src="">
              <!----> <!----> <!----> <!---->
           </div>
        </div>
      </div>
      <!-- end sidebar control -->

      <script src="js/app_v2.js">
          fitStageIntoParentContainer();
          // adapt the stage on any window resize
          window.addEventListener('resize', fitStageIntoParentContainer);        
      </script>

      <script type="text/javascript">
        var section_image_size;
        $.getJSON('http://braincircuits.org/cgi-bin/iipsrv.fcgi?IIIF=/PITT001/Marmo_7NA_7_layers_1um_spacing.jp2/info.json', function(data) {
            width = `${data.width}`
            height = `${data.height}`
            let dect = [width, height];
            section_image_size = dect;
            generateTileTable(dect);
        });

        mouseclick();
        var imageaddress = "http://braincircuits.org/cgi-bin/iipsrv.fcgi?FIF=/PITT001/Marmo_7NA_7_layers_1um_spacing.jp2&WID="+nagImagesize + "&QLT=130&CNT=1&CVT=jpeg";
        $('#navImageSection').attr("src",imageaddress);
        selectedToolBtn();
      </script>

      <script>
        // to be removed //
      $(document).ready(function() {
            $('#picker').colorpicker({
                color:'#ff9800',
                initialHistory: ['#ff0000','#000000','red', 'purple']
            });
            stage.add(layer);
            const nativeCtx = layer.getContext()._context;
            nativeCtx.webkitImageSmoothingEnabled = false;
            nativeCtx.mozImageSmoothingEnabled = false;
            nativeCtx.imageSmoothingEnabled = false;
            nativeCtx.msImageSmoothingEnabled = false;
            bgImage = new Image();
            xpix = 16000; // 16280.0 + 700;
            ypix = 7400 ; //11950.0 + 400;
            xpc = xpix / 24000.0;
            ypc = ypix / 18000.0;
            wpc = wid / 24000.0;
            hpc = hei / 18000.0;
            rgnstring = xpc + "," + ypc + "," + wpc + "," + hpc;
            //bgImage.src = "images/resolver_1020701_12800,16640,544,544.jpg";
            iipbase = "http://braincircuits.org/cgi-bin/iipsrv.fcgi?FIF=";
            // brainno = "PMD2055";
            seriesid = '3362';
            sectionid = '691261';
            apibase = "http://mitradevel.cshl.org/webtools/seriesbrowser";
            $.getJSON(apibase+'/getsectionjp2path/'+sectionid, function(data) {
                jp2filepath = data['jp2Path'];
                
                jp2pathdescribe(jp2filepath);
                bgImage.src =
                    iipbase+jp2pathtranslate_(jp2filepath) +
                    "&WID="+ wid +
                    "&RGN=" + rgnstring +
                    "&MINMAX=1:0,255&MINMAX=2:0,255&MINMAX=3:0,255&GAM=1&CVT=jpeg";
                
                $('#regdetails').html(''+xpix+','+ypix+'; '+wid+'x'+hei);
                bgImage.onload = function() {
                    outimg = new Konva.Image({
                        x: 0,
                        y: 0,
                        width: wid,
                        height: hei,
                        image: bgImage,
                        draggable: false
                    });
                    layer.add(outimg);
                    layer.draw();
                    // layer_vector.draw();
                    console.info('hello world');
                };
            });
        });

        $(document).on("click", "#listTableTiles tbody tr", function() {
            imageid = $(this).closest('tr').attr('id');
            $('#' + imageid).click(function() {
               res = imageid.split('-');
               selectedTile(res[1],section_image_size);
            });
        });
      </script>
    </body>
</html>